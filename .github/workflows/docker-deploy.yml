name: Build and Deploy to Alibaba Cloud

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: crpi-wzl2k45d0lxbiagj.cn-shenzhen.personal.cr.aliyuncs.com
  IMAGE_NAME: bhuang-repo/bhuang-bigmark

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: |
        mvn clean install -DskipTests
        
    - name: Extract metadata
      id: meta
      run: |
        # èŽ·å–åˆ†æ”¯åæˆ–æ ‡ç­¾å
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${GITHUB_REF#refs/heads/}
          VERSION=${VERSION//\//-}
        fi
        
        # å¦‚æžœæ˜¯ä¸»åˆ†æ”¯ï¼Œæ·»åŠ  latest æ ‡ç­¾
        if [[ $VERSION == "main" ]] || [[ $VERSION == "master" ]]; then
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
        else
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
        fi
        
        # æ·»åŠ  commit SHA ä½œä¸ºé¢å¤–æ ‡ç­¾
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${GITHUB_SHA::8}"
        
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM openjdk:17-jre-slim
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /app
        
        # å¤åˆ¶åº”ç”¨ç¨‹åºjaræ–‡ä»¶
        COPY Bhuang-BigMark-app/target/*.jar app.jar
        
        # æš´éœ²ç«¯å£
        EXPOSE 8091
        
        # è®¾ç½®JVMå‚æ•°
        ENV JAVA_OPTS="-Xms512m -Xmx1024m -Dfile.encoding=UTF-8"
        
        # å¯åŠ¨åº”ç”¨
        ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
        EOF
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Alibaba Cloud Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
        password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Image digest
      run: echo "Docker image has been pushed successfully! ðŸš€"
      
    - name: Output deployment instructions
      run: |
        echo "ðŸŽ‰ Docker é•œåƒæž„å»ºå¹¶æŽ¨é€æˆåŠŸï¼"
        echo ""
        echo "ðŸ“¦ é•œåƒä¿¡æ¯ï¼š"
        echo "Registry: ${{ env.REGISTRY }}"
        echo "Repository: ${{ env.IMAGE_NAME }}"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo ""
        echo "ðŸš€ æœ¬åœ°ä½¿ç”¨è¯´æ˜Žï¼š"
        echo ""
        echo "1ï¸âƒ£ ç™»å½•é˜¿é‡Œäº‘ Docker Registryï¼š"
        echo "docker login --username=é»„å¸…å•Š ${{ env.REGISTRY }}"
        echo ""
        echo "2ï¸âƒ£ æ‹‰å–é•œåƒï¼š"
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}"
        echo ""
        echo "3ï¸âƒ£ è¿è¡Œå®¹å™¨ï¼ˆå¼€å‘çŽ¯å¢ƒï¼‰ï¼š"
        echo "docker run -d \\"
        echo "  --name bhuang-bigmark-app \\"
        echo "  -p 8091:8091 \\"
        echo "  -e SPRING_PROFILES_ACTIVE=dev \\"
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}"
        echo ""
        echo "4ï¸âƒ£ è¿è¡Œå®¹å™¨ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰ï¼š"
        echo "docker run -d \\"
        echo "  --name bhuang-bigmark-app \\"
        echo "  -p 8091:8091 \\"
        echo "  -e SPRING_PROFILES_ACTIVE=prod \\"
        echo "  -e JAVA_OPTS='-Xms1g -Xmx2g' \\"
        echo "  --restart unless-stopped \\"
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}"
        echo ""
        echo "5ï¸âƒ£ æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š"
        echo "docker logs -f bhuang-bigmark-app"
        echo ""
        echo "6ï¸âƒ£ åœæ­¢å’Œåˆ é™¤å®¹å™¨ï¼š"
        echo "docker stop bhuang-bigmark-app"
        echo "docker rm bhuang-bigmark-app"
        echo ""
        echo "7ï¸âƒ£ è®¿é—®åº”ç”¨ï¼š"
        echo "å¼€å‘çŽ¯å¢ƒ: http://localhost:8091"
        echo "å¥åº·æ£€æŸ¥: http://localhost:8091/actuator/health"
        echo ""
        echo "ðŸ“ æç¤ºï¼š"
        echo "- ç¡®ä¿æœ¬åœ°ç«¯å£ 8091 æ²¡æœ‰è¢«å ç”¨"
        echo "- å¦‚éœ€ä¿®æ”¹ç«¯å£ï¼Œä½¿ç”¨ -p ä½ çš„ç«¯å£:8091"
        echo "- ç”Ÿäº§çŽ¯å¢ƒå»ºè®®é…ç½®å¤–éƒ¨æ•°æ®åº“è¿žæŽ¥"
        echo "- å¯é€šè¿‡çŽ¯å¢ƒå˜é‡ -e ä¼ é€’é…ç½®å‚æ•°"
        echo ""
        echo "ðŸ”— å®Œæ•´éƒ¨ç½²æ–‡æ¡£è¯·æŸ¥çœ‹ï¼š"
        echo "https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/.github/workflows/README.md"
